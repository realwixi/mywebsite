<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Focus Flow Pro</title>
    
    <style>
        :root {
            --bg-main: #121212;
            --bg-container: #1E1E1E;
            --text-primary: #E0E0E0;
            --text-secondary: #A0A0A0;
            --accent-focus: #82B1FF; 
            --accent-rest: #FFB74D;
            --btn-start: #66bb6a;
            --btn-start-hover: #81c784;
            --btn-reset: #ef5350;
            --btn-reset-hover: #e57373;
            --input-bg: #2C2C2C;
            --border-color: #333;
            --danger-color: #ff5252;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            background-color: var(--bg-main);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 20px;
        }

        .app-container {
            width: 100%;
            max-width: 500px;
            background-color: var(--bg-container);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
        }

        h1 { font-weight: 300; font-size: 1.8rem; margin-bottom: 20px; }

        /* --- Settings & History Panels --- */
        details {
            margin-bottom: 15px;
            background: var(--input-bg);
            border-radius: 10px;
            padding: 10px;
            text-align: left;
        }
        
        summary {
            cursor: pointer;
            color: var(--text-secondary);
            font-size: 0.9em;
            list-style: none;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-weight: 600;
            padding: 5px;
        }
        summary:hover { color: var(--text-primary); }

        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
            padding: 5px;
        }

        .setting-item { display: flex; flex-direction: column; }
        .setting-item label { font-size: 0.8em; color: var(--text-secondary); margin-bottom: 5px; }
        .setting-item input {
            background: var(--bg-main);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 8px;
            border-radius: 5px;
            font-size: 1em;
            text-align: center;
        }

        /* --- History List Styles --- */
        #history-list {
            list-style: none;
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
        }
        .history-item {
            background: var(--bg-main);
            border-bottom: 1px solid var(--border-color);
            padding: 10px;
            font-size: 0.85em;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .history-date { color: var(--text-secondary); font-size: 0.8em; display: block;}
        .history-subject { font-weight: bold; color: var(--accent-focus); }
        
        .clear-btn {
            background: transparent;
            border: 1px solid var(--danger-color);
            color: var(--danger-color);
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.8em;
            cursor: pointer;
            margin-top: 10px;
            width: 100%;
        }
        .clear-btn:hover { background: var(--danger-color); color: white; }

        /* --- Timer & UI --- */
        #progress {
            font-size: 1em;
            color: var(--text-secondary);
            margin: 20px 0 10px 0;
        }

        .timer-container {
            font-family: 'Courier New', monospace;
            font-size: 5.5em; 
            font-weight: 300;
            color: var(--accent-focus);
            margin: 10px 0 30px 0;
            transition: color 0.3s ease;
        }

        .controls { display: flex; gap: 15px; justify-content: center; margin-bottom: 20px; }

        .controls button {
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.1s;
            color: #121212;
            min-width: 120px;
        }

        #start-btn { background-color: var(--btn-start); }
        #start-btn:hover:not(:disabled) { background-color: var(--btn-start-hover); transform: translateY(-2px); }

        #reset-btn { background-color: var(--btn-reset); }
        #reset-btn:hover:not(:disabled) { background-color: var(--btn-reset-hover); transform: translateY(-2px); }

        button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            transform: none !important;
        }
        
        #status-message { font-size: 0.9em; color: var(--text-secondary); min-height: 1.2em;}
        #aipaddr { margin-top: 30px; font-size: 0.8em; color: var(--text-secondary); }

        /* Mobile Adjustments */
        @media (max-width: 600px) {
            .timer-container { font-size: 4em; }
            .controls { flex-direction: column; }
            .controls button { width: 100%; }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <h1>Focus Flow Pro</h1>

        <details id="settings-panel">
            <summary>‚öôÔ∏è Settings</summary>
            <div class="settings-grid">
                <div class="setting-item">
                    <label>Focus (min)</label>
                    <input type="number" id="set-focus" value="25" min="1" max="120">
                </div>
                <div class="setting-item">
                    <label>Rest (min)</label>
                    <input type="number" id="set-rest" value="5" min="1" max="60">
                </div>
                <div class="setting-item">
                    <label>Parts/Session</label>
                    <input type="number" id="set-parts" value="4" min="1" max="10">
                </div>
            </div>
        </details>

        <details id="history-panel">
            <summary>üìú Past Sessions</summary>
            <ul id="history-list">
                <li style="padding:10px; color:#666;">No completed sessions yet.</li>
            </ul>
            <button class="clear-btn" id="clear-history-btn">Delete All History</button>
        </details>

        <div id="progress">Ready to start</div>
        
        <div class="timer-container" id="timer">00:00</div>

        <div class="controls">
            <button id="start-btn">Start</button>
            <button id="reset-btn" disabled>Reset</button>
        </div>

        <p id="status-message">Press Start to begin.</p>
    </div>

    <div id="aipaddr"></div>
    <script async src="https://aruljohn.com/widget/ip.js"></script>

    <audio id="bg-silence" loop>
        <source src="data:audio/mp3;base64,SUQzBAAAAAABAFRYWFgAAAASAAADbWFqb3JfYnJhbmQAbXA0MgBUWFZYAAAAEQAAA21pbm9yX3ZlcnNpb24AMABUWFZYAAAAHAAAA2NvbXBhdGlibGVfYnJhbmRzAGlzb21tcDQyAFRTU0UAAAAPAAADTGF2ZjU3LjU2LjEwMAAAAAAAAAAAAAAA//uQZAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAASW5mbwAAAA8AAAAEAAABIQAABQoODxITFBUWFxkbHR4fIiMkJScoKSorLC0uMDIzNDU3ODk6PT4/QEJERUdJSkxNT1JUVVdZWltcXmFiY2VmZ2lqbG5wc3R1d3h5e3x+gYKDhIWGiImKjY6PkJGSk5SVlpeYmZqbnJ2en6Cio6SlpqeoqaqrrK2ur7CxsrO0tba3uLm6u7y9vr/AwcLDxMXGx8jJysvMzc7P0NHS09TV1tfY2drb3N3e3+Di4+Tl5ufo6err7O3u7/Dx8vP09fb3+Pn6+/z9/v8AAAAATGF2YzU3LjY0AAAAAAAAAAAAAAAAJAAAAAAAAAAAASCCAvPCAAAAAAA//uQZAAP8AAANAAAAAACAAAA0AAAAAAAEAAAEAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//uQZAAP8AAANAAAAAACAAAA0AAAAAAAEAAAEAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" type="audio/mpeg">
    </audio>
    
    <audio id="alarm-sound">
        <source src="data:audio/mp3;base64,SUQzBAAAAAABAFRYWFgAAAASAAADbWFqb3JfYnJhbmQAbXA0MgBUWFZYAAAAEQAAA21pbm9yX3ZlcnNpb24AMABUWFZYAAAAHAAAA2NvbXBhdGlibGVfYnJhbmRzAGlzb21tcDQyAFRTU0UAAAAPAAADTGF2ZjU3LjU2LjEwMAAAAAAAAAAAAAAA//uQZAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAASW5mbwAAAA8AAAADAAAALAAABQoODxITFBUWFxkbHR4fIiMkJScoKSorLC0uMDIzNDU3ODk6PT4/QEJERUdJSkxNT1JUVVdZWltcXmFiY2VmZ2lqbG5wc3R1d3h5e3x+gYKDhIWGiImKjY6PkJGSk5SVlpeYmZqbnJ2en6Cio6SlpqeoqaqrrK2ur7CxsrO0tba3uLm6u7y9vr/AwcLDxMXGx8jJysvMzc7P0NHS09TV1tfY2drb3N3e3+Di4+Tl5ufo6err7O3u7/Dx8vP09fb3+Pn6+/z9/v8AAAAATGF2YzU3LjY0AAAAAAAAAAAAAAAAJAAAAAAAAAAAASCCAvPCAAAAAAA//uQZAAP8AAAK8AAAAACAAAArwAAAAAAEAAAEAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//uQZAAA8AAAK8AAAAACAAAArwAAAAAAEAAAEAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//uQZAEA8AAAK8AAAAACAAAArwAAAAAAEAAAEAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" type="audio/mpeg">
    </audio>

    <script>
        // --- 1. Web Worker Setup (Anti-Throttling) ---
        const workerScript = `
            let timerId;
            self.onmessage = function(e) {
                if (e.data === 'start') {
                    timerId = setInterval(() => { self.postMessage('tick'); }, 1000);
                } else if (e.data === 'stop') {
                    clearInterval(timerId);
                }
            };
        `;
        const blob = new Blob([workerScript], { type: 'application/javascript' });
        const worker = new Worker(URL.createObjectURL(blob));

        // --- 2. Wake Lock (Mobile Screen) ---
        let wakeLock = null;
        async function requestWakeLock() {
            if ('wakeLock' in navigator) {
                try { wakeLock = await navigator.wakeLock.request('screen'); } catch (err) { console.log(err); }
            }
        }
        async function releaseWakeLock() {
            if (wakeLock !== null) { await wakeLock.release(); wakeLock = null; }
        }

        // --- 3. App Logic ---
        
        // UI Elements
        const inputFocus = document.getElementById('set-focus');
        const inputRest = document.getElementById('set-rest');
        const inputParts = document.getElementById('set-parts');
        const settingsDetails = document.getElementById('settings-panel');
        const historyList = document.getElementById('history-list');
        const clearHistoryBtn = document.getElementById('clear-history-btn');
        
        const timerDisplay = document.getElementById('timer');
        const progressDisplay = document.getElementById('progress');
        const statusMessage = document.getElementById('status-message');
        const startBtn = document.getElementById('start-btn');
        const resetBtn = document.getElementById('reset-btn');

        // Audio
        const bgSilence = document.getElementById('bg-silence');
        const alarmSound = document.getElementById('alarm-sound');

        // State
        let isRest = false;
        let currentPart = 1; 
        let totalParts = 4;
        let endTime = 0; 
        let timeRemaining = 0;
        
        // --- HISTORY MANAGEMENT ---
        function loadHistory() {
            const historyData = JSON.parse(localStorage.getItem('pomodoro_history') || '[]');
            historyList.innerHTML = '';
            
            if (historyData.length === 0) {
                historyList.innerHTML = '<li style="padding:10px; color:#666;">No completed sessions yet.</li>';
                return;
            }

            // Show newest first
            historyData.reverse().forEach(item => {
                const li = document.createElement('li');
                li.className = 'history-item';
                li.innerHTML = `
                    <div>
                        <span class="history-subject">${item.subject}</span>
                        <span class="history-date">${item.date} at ${item.time}</span>
                    </div>
                    <div>‚úÖ</div>
                `;
                historyList.appendChild(li);
            });
        }

        function saveSessionToHistory(subject) {
            const now = new Date();
            const sessionData = {
                subject: subject,
                date: now.toLocaleDateString(),
                time: now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                timestamp: now.getTime()
            };
            
            const history = JSON.parse(localStorage.getItem('pomodoro_history') || '[]');
            history.push(sessionData);
            localStorage.setItem('pomodoro_history', JSON.stringify(history));
            loadHistory();
        }

        function clearHistory() {
            if(confirm("Are you sure you want to delete all past session history?")) {
                localStorage.removeItem('pomodoro_history');
                loadHistory();
            }
        }

        // --- AUDIO ENGINE ---
        function startAudioSession() {
            bgSilence.play().catch(e => console.log("Audio autoplay blocked", e));
        }
        function stopAudioSession() {
            bgSilence.pause();
            bgSilence.currentTime = 0;
        }
        function playAlarm() {
            alarmSound.currentTime = 0;
            alarmSound.play().catch(e => console.log("Alarm blocked", e));
        }
        
        // --- UTILS ---
        function sendNotification(title, body) {
            if (Notification.permission === 'granted') new Notification(title, { body });
        }
        function formatTime(seconds) {
            const m = String(Math.floor(seconds / 60)).padStart(2, '0');
            const s = String(seconds % 60).padStart(2, '0');
            return `${m}:${s}`;
        }

        // --- TIMER CORE ---
        function updateUI() {
            timerDisplay.textContent = formatTime(timeRemaining);
            let phaseName = isRest ? 'REST' : 'FOCUS';
            progressDisplay.textContent = `Part ${currentPart}/${totalParts} ‚Ä¢ ${phaseName}`;
            timerDisplay.style.color = isRest ? 'var(--accent-rest)' : 'var(--accent-focus)';
        }

        worker.onmessage = function(e) {
            if (e.data === 'tick') {
                const now = Date.now();
                const diff = Math.ceil((endTime - now) / 1000);
                timeRemaining = diff;

                if (diff <= 0) {
                    stopInternal();
                    timeRemaining = 0;
                    updateUI();
                    handlePhaseEnd();
                } else {
                    updateUI();
                }
            }
        };

        function startTimer(durationSeconds) {
            endTime = Date.now() + (durationSeconds * 1000);
            timeRemaining = durationSeconds;
            
            worker.postMessage('start');
            requestWakeLock();
            
            startBtn.disabled = true;
            resetBtn.disabled = false;
            [inputFocus, inputRest, inputParts].forEach(el => el.disabled = true);
            updateUI();
        }
        
        function stopInternal() {
            worker.postMessage('stop');
            releaseWakeLock();
        }

        function handlePhaseEnd() {
            if (!isRest) { 
                // Finished Focus
                playAlarm();
                sendNotification('Break Time', `Time to rest.`);
                isRest = true;
                const restMin = parseInt(inputRest.value) || 5;
                startTimer(restMin * 60);
            } else { 
                // Finished Rest
                isRest = false;
                currentPart++;

                if (currentPart > totalParts) { 
                    // Session Done
                    playAlarm();
                    sendNotification('All Done!', 'Session complete.');
                    
                    // Save to history
                    const sessionName = localStorage.getItem('current_session_name') || "Untitled";
                    saveSessionToHistory(sessionName);
                    
                    resetSystem(false);
                    statusMessage.textContent = `Completed & Saved: ${sessionName}`;
                    progressDisplay.textContent = 'Session Complete';
                } else { 
                    // Next Focus
                    playAlarm(); 
                    sendNotification('Back to Work', `Starting Part ${currentPart}`);
                    const focusMin = parseInt(inputFocus.value) || 25;
                    startTimer(focusMin * 60);
                }
            }
        }
        
        function resetSystem(promptUser = true) {
            stopInternal();
            stopAudioSession();
            currentPart = 1;
            isRest = false;
            
            [inputFocus, inputRest, inputParts].forEach(el => el.disabled = false);

            const focusMin = parseInt(inputFocus.value) || 25;
            totalParts = parseInt(inputParts.value) || 4;
            timeRemaining = focusMin * 60;
            
            timerDisplay.style.color = 'var(--accent-focus)';
            timerDisplay.textContent = formatTime(timeRemaining);
            progressDisplay.textContent = `Ready: ${totalParts} Parts`;
            
            startBtn.disabled = false;
            resetBtn.disabled = true;

            if (promptUser) {
                statusMessage.textContent = 'Press Start to begin.';
                localStorage.removeItem('current_session_name');
            }
        }

        function initSession() {
            startAudioSession(); // Keep browser awake

            // Read & Save Settings
            let f = parseInt(inputFocus.value) || 25;
            let r = parseInt(inputRest.value) || 5;
            let p = parseInt(inputParts.value) || 4;
            
            localStorage.setItem('pref_focus', f);
            localStorage.setItem('pref_rest', r);
            localStorage.setItem('pref_parts', p);
            totalParts = p;

            const name = prompt("Session Subject:", localStorage.getItem('current_session_name') || "Task");
            if (name === null) {
                stopAudioSession();
                return;
            }
            
            localStorage.setItem('current_session_name', name || "Untitled");
            statusMessage.textContent = `Focusing on: ${name || "Untitled"}`;
            settingsDetails.removeAttribute("open");
            
            stopInternal();
            currentPart = 1;
            isRest = false;
            startTimer(f * 60);
        }

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            // Load Settings
            if(localStorage.getItem('pref_focus')) inputFocus.value = localStorage.getItem('pref_focus');
            if(localStorage.getItem('pref_rest')) inputRest.value = localStorage.getItem('pref_rest');
            if(localStorage.getItem('pref_parts')) inputParts.value = localStorage.getItem('pref_parts');

            loadHistory();
            resetSystem(true);

            // Permissions
            if (localStorage.getItem('storage_agreed') !== 'true') {
                 if(confirm("Enable browser storage for settings & history?")) localStorage.setItem('storage_agreed', 'true');
            }
            if (Notification.permission !== 'granted' && Notification.permission !== 'denied') Notification.requestPermission();
            
            // Re-lock wake on visibility
            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'visible' && startBtn.disabled) requestWakeLock();
            });
            
            // Event Listeners
            startBtn.addEventListener('click', initSession);
            resetBtn.addEventListener('click', () => { if(confirm("Stop and reset timer?")) resetSystem(); });
            clearHistoryBtn.addEventListener('click', clearHistory);
        });
    </script>
</body>
</html>
